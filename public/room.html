<!DOCTYPE html>
<html>
<head>
    <title>WebRTC房间</title>
    <style>
        #video-container {
            display: flex;
            gap: 20px;
        }
        video {
            width: 400px;
            height: 300px;
            border: 1px solid #ccc;
        }
        #chat-box {
            margin-top: 20px;
            width: 820px;
        }
    </style>
</head>
<body>
    <div id="video-container">
        <video id="localVideo" autoplay muted></video>
        <video id="remoteVideo" autoplay></video>
    </div>
    
    <div id="chat-box">
        <div id="messages" style="height: 200px; border: 1px solid #ccc; overflow-y: auto"></div>
        <input type="text" id="messageInput" placeholder="输入消息">
        <button onclick="sendMessage()">发送</button>
    </div>

    <script>
        const roomId = new URLSearchParams(window.location.search).get('roomId');
        const ws = new WebSocket(`ws://localhost:3000?roomId=${roomId}`);
        let localStream;
        let remoteStream;
        let peerConnection;
        let dataChannel;

        // WebRTC配置
        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ]
        };

        // 初始化本地视频
        async function initLocalVideo() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('localVideo').srcObject = localStream;
            } catch (err) {
                console.error('无法获取媒体设备:', err);
            }
        }

        // 创建PeerConnection
        function createPeerConnection(isOfferer) {
            peerConnection = new RTCPeerConnection(config);

            // 仅发起方创建数据通道
            if (isOfferer) {
                dataChannel = peerConnection.createDataChannel('chat');
                setupDataChannel();
            } else {
                peerConnection.ondatachannel = (event) => {
                    dataChannel = event.channel;
                    setupDataChannel();
                };
            }

            // 添加本地流
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // 处理ICE候选
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({ type: 'candidate', candidate: event.candidate }));
                }
            };

            // 处理远程流
            peerConnection.ontrack = (event) => {
                document.getElementById('remoteVideo').srcObject = event.streams[0];
            };

            // 创建数据通道
            dataChannel = peerConnection.createDataChannel('chat');
            console.log('数据通道状态:', dataChannel.readyState);
            setupDataChannel();
        }

        // 设置数据通道
        function setupDataChannel() {
            dataChannel.onmessage = (event) => {
                const messages = document.getElementById('messages');
                messages.innerHTML += `<div><b>对方:</b> ${event.data}</div>`;
                messages.scrollTop = messages.scrollHeight;
            };

            dataChannel.onopen = () => {
                console.log('数据通道已打开');
            };
        }

        // 处理信令消息
        ws.onmessage = async (message) => {
            const data = JSON.parse(message.data);

            if (data.type === 'offer') {
                createPeerConnection(ture);
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                ws.send(JSON.stringify({ type: 'answer', sdp: peerConnection.localDescription }));

            } else if (data.type === 'answer') {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data));

            } else if (data.type === 'candidate') {
                await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
            }
        };

        // 发送消息
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value;
            if (message && dataChannel.readyState === 'open') {
            
                dataChannel.send(message);
                const messages = document.getElementById('messages');
                messages.innerHTML += `<div><b>我:</b> ${message}</div>`;
                messages.scrollTop = messages.scrollHeight;
                input.value = '';
            } else{
                console.error('数据通道未就绪');
            }
        }

        // 初始化
        async function init() {
            await initLocalVideo();
            createPeerConnection(true);
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            ws.send(JSON.stringify({ type: 'offer', sdp: peerConnection.localDescription }));
        }

        // 处理页面关闭
        window.onbeforeunload = () => {
            ws.close();
        };

        init();
    </script>
</body>
</html>